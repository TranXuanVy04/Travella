<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Travela Chatbot - Tư Vấn Du Lịch AI</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        #travela-bubble {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            transition: transform 0.3s;
            z-index: 1000;
        }

            #travela-bubble:hover {
                transform: scale(1.1);
            }

            #travela-bubble::before {
                content: '💬';
                font-size: 30px;
            }

        #travela-chatbox {
            position: fixed;
            bottom: 100px;
            right: 30px;
            width: 420px;
            max-width: calc(100vw - 60px);
            height: 650px;
            max-height: calc(100vh - 140px);
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            display: none;
            flex-direction: column;
            overflow: hidden;
            z-index: 999;
        }

            #travela-chatbox.active {
                display: flex;
            }

        .chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

            .chat-header .avatar {
                width: 40px;
                height: 40px;
                background: white;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 20px;
            }

            .chat-header .info h3 {
                font-size: 16px;
                margin-bottom: 4px;
            }

            .chat-header .info .status {
                font-size: 12px;
                opacity: 0.9;
            }

                .chat-header .info .status.online::before {
                    content: '🟢 ';
                }

        #travela-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            background: #f8f9fa;
        }

        .message {
            padding: 12px 16px;
            border-radius: 16px;
            max-width: 85%;
            word-wrap: break-word;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .bot-msg {
            align-self: flex-start;
            background: #e9ecef;
            color: #333;
        }

        .user-msg {
            align-self: flex-end;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .typing-indicator {
            align-self: flex-start;
            background: #e9ecef;
            padding: 12px 16px;
            border-radius: 16px;
            display: none;
        }

            .typing-indicator.active {
                display: block;
            }

            .typing-indicator span {
                display: inline-block;
                width: 8px;
                height: 8px;
                border-radius: 50%;
                background: #667eea;
                margin: 0 2px;
                animation: typing 1.4s infinite;
            }

                .typing-indicator span:nth-child(2) {
                    animation-delay: 0.2s;
                }

                .typing-indicator span:nth-child(3) {
                    animation-delay: 0.4s;
                }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
            }

            30% {
                transform: translateY(-10px);
            }
        }

        .chat-input-area {
            padding: 16px;
            background: white;
            border-top: 1px solid #e9ecef;
            display: flex;
            gap: 10px;
        }

        #travela-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 24px;
            outline: none;
            font-size: 14px;
            transition: border-color 0.3s;
        }

            #travela-input:focus {
                border-color: #667eea;
            }

        .send-btn {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }

            .send-btn:hover {
                transform: scale(1.1);
            }

            .send-btn::before {
                content: '➤';
                font-size: 18px;
            }

        .tour-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 12px;
            padding: 14px;
            margin-top: 8px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            border: 1px solid #e9ecef;
            transition: transform 0.2s, box-shadow 0.2s;
        }

            .tour-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 16px rgba(0,0,0,0.12);
            }

            .tour-card .tour-header {
                display: flex;
                justify-content: space-between;
                align-items: start;
                margin-bottom: 8px;
            }

            .tour-card h4 {
                color: #667eea;
                margin-bottom: 6px;
                font-size: 14px;
                flex: 1;
            }

            .tour-card .tour-code {
                background: #667eea;
                color: white;
                padding: 2px 8px;
                border-radius: 12px;
                font-size: 10px;
                font-weight: bold;
            }

            .tour-card p {
                font-size: 13px;
                color: #666;
                margin: 4px 0;
                line-height: 1.6;
            }

            .tour-card .price {
                color: #e74c3c;
                font-weight: bold;
                font-size: 16px;
                margin-top: 8px;
            }

            .tour-card .seats {
                display: inline-block;
                background: #d4edda;
                color: #155724;
                padding: 4px 10px;
                border-radius: 12px;
                font-size: 11px;
                margin-top: 6px;
            }

        .quick-replies {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .quick-reply-btn {
            background: white;
            border: 2px solid #667eea;
            color: #667eea;
            padding: 8px 14px;
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s;
        }

            .quick-reply-btn:hover {
                background: #667eea;
                color: white;
            }

        .error-notice {
            background: #fff3cd;
            border: 1px solid #ffc107;
            color: #856404;
            padding: 10px 12px;
            border-radius: 8px;
            font-size: 12px;
            margin-top: 8px;
        }

        .demo-panel {
            position: fixed;
            top: 20px;
            left: 20px;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            max-width: 320px;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
        }

            .demo-panel h3 {
                color: #667eea;
                margin-bottom: 15px;
                font-size: 18px;
            }

            .demo-panel button {
                width: 100%;
                padding: 10px;
                margin: 6px 0;
                background: #667eea;
                color: white;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                font-size: 13px;
                transition: background 0.3s;
                text-align: left;
            }

                .demo-panel button:hover {
                    background: #5568d3;
                }

            .demo-panel .note {
                font-size: 12px;
                color: #666;
                margin-top: 15px;
                padding: 10px;
                background: #f8f9fa;
                border-radius: 6px;
                line-height: 1.5;
            }

        @media (max-width: 768px) {
            .demo-panel {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- Panel demo -->
    <div class="demo-panel">
        <h3>🎯 Tin nhắn mẫu</h3>
        <button onclick="testMessage('Tour Paris lãng mạn')">🗼 Tour Paris Honeymoon</button>
        <button onclick="testMessage('Tour Nhật Bản văn hóa')">🎌 Tour Nhật Bản</button>
        <button onclick="testMessage('Tour giá dưới 1000 USD')">💰 Tour giá rẻ</button>
        <button onclick="testMessage('Tour gia đình có trẻ em')">👨‍👩‍👧‍👦 Tour gia đình</button>
        <button onclick="testMessage('Tour mạo hiểm leo núi')">⛰️ Adventure tour</button>
        <button onclick="testMessage('Tour ẩm thực Italy')">🍝 Ẩm thực Châu Âu</button>
        <button onclick="testMessage('Còn chỗ nào cho tháng này?')">📅 Kiểm tra chỗ trống</button>
        <div class="note">
            <strong>💡 Lưu ý:</strong> Chatbot đang lấy dữ liệu từ <code>/TourData.ashx</code>. Nếu API không hoạt động, sẽ dùng dữ liệu mẫu.<br><br>
            <strong>🤖 AI nhớ hội thoại:</strong> Thử hỏi tiếp "Còn tour nào khác?", "Tour rẻ hơn được không?"
        </div>
    </div>

    <div id="travela-bubble"></div>
    <div id="travela-chatbox">
        <div class="chat-header">
            <div class="avatar">✈️</div>
            <div class="info">
                <h3>Tư Vấn Viên Travela AI</h3>
                <div class="status online">Sẵn sàng tư vấn</div>
            </div>
        </div>
        <div id="travela-messages">
            <div class="typing-indicator" id="typing">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        <div class="chat-input-area">
            <input type="text" id="travela-input" placeholder="Nhập câu hỏi của bạn...">
            <button class="send-btn" onclick="sendMsg()"></button>
        </div>
    </div>

    <script>
        // ===== QUẢN LÝ UI =====
        const bubble = document.getElementById('travela-bubble');
        const chatbox = document.getElementById('travela-chatbox');
        const messages = document.getElementById('travela-messages');
        const input = document.getElementById('travela-input');
        const typing = document.getElementById('typing');

        bubble.onclick = () => {
            chatbox.classList.toggle('active');
            if (chatbox.classList.contains('active') && conversationHistory.length === 0) {
                showWelcomeMessage();
            }
        };

        // ===== QUẢN LÝ DỮ LIỆU & HỘI THOẠI =====
        let conversationHistory = [];
        let tourCache = null;
        let lastFetchTime = 0;
        const CACHE_DURATION = 5 * 60 * 1000; // 5 phút
        const API_ENDPOINT = '/TourData.ashx'; // Thay URL của anh/chị ở đây

        function addToHistory(role, content) {
            conversationHistory.push({ role, content });
            if (conversationHistory.length > 10) {
                conversationHistory = conversationHistory.slice(-10);
            }
        }

        // ===== LẤY DỮ LIỆU TOUR TỪ API =====
        async function getTours() {
            const now = Date.now();

            // Kiểm tra cache
            if (tourCache && (now - lastFetchTime < CACHE_DURATION)) {
                console.log('✅ Sử dụng cache');
                return tourCache;
            }

            try {
                console.log('🔄 Đang fetch dữ liệu từ API...');
                const res = await fetch(API_ENDPOINT);

                if (!res.ok) throw new Error(`HTTP ${res.status}`);

                const data = await res.json();

                if (!Array.isArray(data) || data.length === 0) {
                    throw new Error('Dữ liệu không hợp lệ');
                }

                tourCache = data;
                lastFetchTime = now;
                console.log(`✅ Đã tải ${data.length} tour`);
                return tourCache;

            } catch (err) {
                console.error('❌ Lỗi API:', err);

                // Fallback: Dùng dữ liệu mẫu nếu API lỗi
                if (!tourCache) {
                    console.log('⚠️ Dùng dữ liệu mẫu dự phòng');
                    tourCache = FALLBACK_TOURS;
                }
                return tourCache;
            }
        }

        // ===== DỮ LIỆU MẪU DỰ PHÒNG =====
        const FALLBACK_TOURS = [
            { "MaTour": "TOUR001", "TenTour": "Luxury Honeymoon Paris 7N6Đ", "Gia": 35000, "SoChoCon": 10, "PhuongTien": "Máy bay", "MoTa": "Chuyến đi lãng mạn cao cấp, bao gồm du thuyền trên sông Seine và khách sạn 5 sao." },
            { "MaTour": "TOUR002", "TenTour": "Kyoto Cổ Kính & Văn Hóa 8 Ngày", "Gia": 1850.5, "SoChoCon": 20, "PhuongTien": "Máy bay", "MoTa": "Khám phá các đền thờ cổ, trà đạo truyền thống và khu phố Gion." },
            { "MaTour": "TOUR003", "TenTour": "Ẩm Thực Phục Hưng Florence 6 Ngày", "Gia": 1200, "SoChoCon": 15, "PhuongTien": "Máy bay", "MoTa": "Học làm Pasta, nếm rượu vang Chianti và thăm chợ trung tâm." },
            { "MaTour": "TOUR007", "TenTour": "New York Gia Đình 5 Ngày", "Gia": 980.5, "SoChoCon": 40, "PhuongTien": "Máy bay", "MoTa": "Tượng Nữ thần Tự do, Times Square và Bảo tàng Lịch sử Tự nhiên." },
            { "MaTour": "TOUR015", "TenTour": "Honeymoon Santorini 7 Ngày", "Gia": 2900, "SoChoCon": 5, "PhuongTien": "Máy bay", "MoTa": "Tour trăng mật sang trọng, ngắm hoàng hôn và biệt thự riêng." }
        ];

        // ===== HIỂN THỊ TIN NHẮN =====
        function botReply(text, isHTML = false, showQuickReplies = false) {
            typing.classList.remove('active');
            const msg = document.createElement('div');
            msg.className = 'message bot-msg';
            if (isHTML) {
                msg.innerHTML = text;
            } else {
                msg.textContent = text;
            }

            if (showQuickReplies) {
                const quickReplies = document.createElement('div');
                quickReplies.className = 'quick-replies';
                quickReplies.innerHTML = `
                        <button class="quick-reply-btn" onclick="testMessage('Tour lãng mạn')">💑 Lãng mạn</button>
                        <button class="quick-reply-btn" onclick="testMessage('Tour gia đình')">👨‍👩‍👧 Gia đình</button>
                        <button class="quick-reply-btn" onclick="testMessage('Tour mạo hiểm')">⛰️ Mạo hiểm</button>
                        <button class="quick-reply-btn" onclick="testMessage('Tour ẩm thực')">🍜 Ẩm thực</button>
                    `;
                msg.appendChild(quickReplies);
            }

            messages.insertBefore(msg, typing);
            messages.scrollTop = messages.scrollHeight;
        }

        function userReply(text) {
            const msg = document.createElement('div');
            msg.className = 'message user-msg';
            msg.textContent = text;
            messages.insertBefore(msg, typing);
            messages.scrollTop = messages.scrollHeight;
        }

        function showTyping() {
            typing.classList.add('active');
            messages.scrollTop = messages.scrollHeight;
        }

        // ===== XỬ LÝ THÔNG MINH =====
        function findRelevantTours(userText, tours) {
            const text = userText.toLowerCase();
            let filtered = [...tours];

            // Trích xuất giá
            const priceMatch = text.match(/(\d+)\s*(usd|đô|dollar|\$)/i);
            const budgetLimit = priceMatch ? parseFloat(priceMatch[1]) : null;

            // Lọc theo từ khóa
            const keywords = {
                'paris': ['paris'],
                'nhật': ['kyoto', 'tokyo', 'japan'],
                'italy': ['florence', 'venice', 'rome', 'tuscany'],
                'mỹ': ['new york', 'ny'],
                'lãng mạn': ['honeymoon', 'santorini', 'paris', 'venice'],
                'gia đình': ['family', 'gia đình'],
                'mạo hiểm': ['adventure', 'extreme', 'leo núi', 'trekking'],
                'ẩm thực': ['culinary', 'ẩm thực', 'food'],
                'team building': ['team building', 'retreat'],
                'văn hóa': ['văn hóa', 'lịch sử', 'di sản']
            };

            for (const [key, patterns] of Object.entries(keywords)) {
                if (text.includes(key)) {
                    filtered = filtered.filter(t =>
                        patterns.some(pattern =>
                            t.TenTour.toLowerCase().includes(pattern) ||
                            t.MoTa.toLowerCase().includes(pattern)
                        )
                    );
                    break;
                }
            }

            // Lọc theo giá
            if (budgetLimit) {
                filtered = filtered.filter(t => parseFloat(t.Gia) <= budgetLimit);
            }

            // Lọc theo số chỗ còn
            if (text.includes('còn chỗ') || text.includes('available')) {
                filtered = filtered.filter(t => t.SoChoCon > 0);
            }

            return filtered.slice(0, 4);
        }

        function generateResponse(userText, relevantTours) {
            const text = userText.toLowerCase();
            let response = '';

            if (relevantTours.length === 0) {
                response = `Dạ em xin lỗi anh/chị 😢<br><br>Em chưa tìm thấy tour phù hợp với yêu cầu này. Anh/chị có thể:<br>
                    • Thử tìm kiếm với từ khóa khác<br>
                    • Điều chỉnh ngân sách<br>
                    • Linh hoạt về điểm đến<br><br>
                    Hoặc anh/chị nói rõ hơn để em tư vấn tốt hơn nha! ❤️`;
            } else {
                // Tạo response thông minh dựa trên context
                if (text.includes('lãng mạn') || text.includes('honeymoon')) {
                    response = `Dạ em có những tour lãng mạn tuyệt vời cho anh/chị đây ạ! 💑✨<br><br>`;
                } else if (text.includes('gia đình')) {
                    response = `Dạ em gợi ý những tour phù hợp cho cả gia đình nè! 👨‍👩‍👧‍👦❤️<br><br>`;
                } else if (text.includes('mạo hiểm')) {
                    response = `Dạ tour mạo hiểm đầy kịch tính cho anh/chị đây! ⛰️🔥<br><br>`;
                } else if (text.includes('ẩm thực')) {
                    response = `Dạ tour ẩm thực tuyệt vời cho anh/chị sành ăn nè! 🍜😋<br><br>`;
                } else {
                    response = `Dạ em tìm được những tour phù hợp cho anh/chị đây ạ! ✈️😊<br><br>`;
                }

                // Hiển thị tour cards
                relevantTours.forEach((tour, i) => {
                    const price = parseFloat(tour.Gia);
                    const priceFormatted = price >= 1000
                        ? `${price.toLocaleString('en-US')} USD`
                        : `${price.toLocaleString('vi-VN')}đ`;

                    response += `<div class="tour-card">
                            <div class="tour-header">
                                <h4>${tour.TenTour}</h4>
                                <span class="tour-code">${tour.MaTour}</span>
                            </div>
                            <p>${tour.MoTa}</p>
                            <p>✈️ Phương tiện: ${tour.PhuongTien}</p>
                            <p class="price">💰 ${priceFormatted}/khách</p>
                            <span class="seats">📍 Còn ${tour.SoChoCon} chỗ</span>
                        </div>`;
                });

                response += '<br>Anh/chị thích tour nào để em tư vấn chi tiết hơn nhé! 😊';
            }

            return response;
        }

        // ===== GỬI TIN NHẮN =====
        async function sendMsg() {
            const userText = input.value.trim();
            if (!userText) return;

            userReply(userText);
            addToHistory('user', userText);
            input.value = '';
            showTyping();

            // Lấy dữ liệu tour
            const tours = await getTours();

            if (!tours || tours.length === 0) {
                botReply("Em xin lỗi 😢 Hiện không thể tải dữ liệu tour. Anh/chị thử lại sau nhé! ❤️");
                return;
            }

            // Delay để tạo cảm giác tự nhiên
            setTimeout(() => {
                const relevantTours = findRelevantTours(userText, tours);
                const response = generateResponse(userText, relevantTours);
                addToHistory('assistant', response);
                botReply(response, true);
            }, 800 + Math.random() * 800);
        }

        // ===== TEST MESSAGE =====
        function testMessage(msg) {
            if (!chatbox.classList.contains('active')) {
                chatbox.classList.add('active');
                if (conversationHistory.length === 0) {
                    showWelcomeMessage();
                }
            }

            setTimeout(() => {
                input.value = msg;
                input.focus();
                setTimeout(() => sendMsg(), 500);
            }, 500);
        }

        // ===== LỜI CHÀO =====
        function showWelcomeMessage() {
            setTimeout(() => {
                botReply(`Chào anh/chị ơi! Em là AI Tư Vấn Viên Travela đây ạ ❤️✈️<br><br>
                    Em có thể giúp anh/chị:<br>
                    • Tìm tour phù hợp với ngân sách<br>
                    • Gợi ý điểm đến lãng mạn, gia đình, mạo hiểm...<br>
                    • Kiểm tra chỗ trống và giá tour<br><br>
                    Anh/chị muốn đi đâu, kiểu tour nào để em tư vấn nhé! 😊`, true, true);
            }, 500);
        }

        // ===== EVENTS =====
        input.addEventListener('keypress', e => {
            if (e.key === 'Enter') sendMsg();
        });

        const observer = new MutationObserver(() => {
            messages.scrollTop = messages.scrollHeight;
        });
        observer.observe(messages, { childList: true });

        // Auto mở chatbox để demo
        setTimeout(() => {
            chatbox.classList.add('active');
            showWelcomeMessage();
        }, 1000);
    </script>
</body>
</html>